<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowchart Collaborator - Tool Belt</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components.css">
    
    <!-- D3.js for SVG manipulation -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        /* Flowchart-specific styles */
        .flowchart-container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            background: var(--gray-light);
        }

        .flowchart-toolbar {
            background: var(--white);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            padding-right: var(--spacing-md);
            border-right: 1px solid var(--border-color);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-label {
            font-size: 12px;
            color: var(--gray-dark);
            font-weight: 600;
        }

        .main-workspace {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 0;
            height: 100%;
            overflow: hidden;
        }

        .canvas-container {
            position: relative;
            background: var(--white);
            border-right: 1px solid var(--border-color);
            overflow: hidden;
        }

        #flowchart-canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #flowchart-canvas:active {
            cursor: grabbing;
        }

        .sidebar {
            background: var(--gray-light);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-tabs {
            display: flex;
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-tab {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--gray-light);
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-dark);
            text-transform: uppercase;
            transition: all 0.2s ease;
        }

        .sidebar-tab.active {
            background: var(--white);
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .sidebar-content {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
        }

        .status-bar {
            background: var(--white);
            padding: var(--spacing-sm) var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--gray-dark);
        }

        .status-info {
            display: flex;
            gap: var(--spacing-lg);
        }

        /* Node type buttons */
        .node-type-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .node-type-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
        }

        .node-type-btn.active {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .node-type-icon {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            background: currentColor;
        }

        .node-type-icon.oval {
            border-radius: 50%;
        }

        .node-type-icon.diamond {
            transform: rotate(45deg);
        }

        .node-type-icon.circle {
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }

        /* Import/Export modal */
        .import-export-area {
            width: 100%;
            height: 300px;
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        /* Properties panel */
        .property-group {
            margin-bottom: var(--spacing-lg);
        }

        .property-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-dark);
        }

        .property-input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .status-buttons {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .status-btn {
            flex: 1;
            padding: var(--spacing-xs);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--white);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .status-btn.approved {
            background: var(--success-color);
            color: var(--white);
            border-color: var(--success-color);
        }

        .status-btn.pending {
            background: var(--warning-color);
            color: var(--white);
            border-color: var(--warning-color);
        }

        .status-btn.rejected {
            background: var(--error-color);
            color: var(--white);
            border-color: var(--error-color);
        }

        /* Questions panel */
        .question-item {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .question-category {
            display: inline-block;
            padding: 2px 6px;
            background: var(--primary-light);
            color: var(--primary-color);
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: var(--spacing-sm);
        }

        .question-text {
            font-size: 14px;
            margin-bottom: var(--spacing-md);
            line-height: 1.4;
        }

        .question-answer {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 13px;
            min-height: 60px;
            resize: vertical;
        }

        /* Canvas grid */
        .canvas-grid {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 0.5;
            opacity: 0.3;
        }

        /* Flowchart nodes and connections styles */
        .flowchart-node {
            cursor: move;
            transition: all 0.2s ease;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
        }

        .flowchart-node:hover {
            filter: drop-shadow(2px 2px 8px rgba(0,0,0,0.2));
        }

        .flowchart-node.selected {
            stroke: var(--primary-color);
            stroke-width: 3px;
        }

        .flowchart-node.approved {
            stroke: var(--success-color);
            stroke-width: 3px;
        }

        .flowchart-node.rejected {
            stroke: var(--error-color);
            stroke-width: 3px;
            opacity: 0.6;
        }

        .flowchart-node.pending {
            stroke: var(--warning-color);
            stroke-width: 3px;
        }

        .node-text {
            font-size: 12px;
            fill: var(--text-color);
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
            user-select: none;
        }

        .flowchart-connection {
            fill: none;
            stroke: var(--gray-dark);
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }

        .flowchart-connection.selected {
            stroke: var(--primary-color);
            stroke-width: 3;
        }

        .flowchart-connection.approved {
            stroke: var(--success-color);
        }

        .flowchart-connection.rejected {
            stroke: var(--error-color);
            opacity: 0.6;
        }

        .connection-label {
            font-size: 11px;
            fill: var(--gray-dark);
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .question-badge {
            fill: var(--warning-color);
            stroke: var(--white);
            stroke-width: 2;
        }

        .question-badge-text {
            fill: var(--white);
            font-size: 10px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
        }
    </style>
</head>
<body>
    <div class="flowchart-container">
        <!-- Toolbar -->
        <div class="flowchart-toolbar">
            <div class="toolbar-group">
                <span class="toolbar-label">File</span>
                <button class="btn btn-sm btn-primary" onclick="showImportModal()">üì• Import JSON</button>
                <button class="btn btn-sm btn-secondary" onclick="exportToJSON()">üì§ Export JSON</button>
                <button class="btn btn-sm btn-secondary" onclick="saveProgress()">üíæ Save</button>
                <button class="btn btn-sm btn-secondary" onclick="clearCanvas()">üóëÔ∏è Clear</button>
            </div>
            
            <div class="toolbar-group">
                <span class="toolbar-label">Add Nodes</span>
                <button class="node-type-btn" data-type="start" onclick="selectNodeType('start')">
                    <div class="node-type-icon oval"></div>
                    Start
                </button>
                <button class="node-type-btn" data-type="process" onclick="selectNodeType('process')">
                    <div class="node-type-icon"></div>
                    Process
                </button>
                <button class="node-type-btn" data-type="decision" onclick="selectNodeType('decision')">
                    <div class="node-type-icon diamond"></div>
                    Decision
                </button>
                <button class="node-type-btn" data-type="end" onclick="selectNodeType('end')">
                    <div class="node-type-icon oval"></div>
                    End
                </button>
                <button class="node-type-btn" data-type="connector" onclick="selectNodeType('connector')">
                    <div class="node-type-icon circle"></div>
                    Connector
                </button>
            </div>
            
            <div class="toolbar-group">
                <span class="toolbar-label">Mode</span>
                <button class="btn btn-sm" id="selectMode" onclick="setMode('select')">üîç Select</button>
                <button class="btn btn-sm" id="connectMode" onclick="setMode('connect')">üîó Connect</button>
            </div>
            
            <div class="toolbar-group">
                <span class="toolbar-label">View</span>
                <button class="btn btn-sm btn-secondary" onclick="fitToScreen()">üîç Fit All</button>
                <button class="btn btn-sm btn-secondary" onclick="resetZoom()">1:1</button>
            </div>
        </div>

        <!-- Main workspace -->
        <div class="main-workspace">
            <!-- Canvas -->
            <div class="canvas-container">
                <svg id="flowchart-canvas">
                    <!-- Defs for arrowheads and patterns -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--gray-dark)" />
                        </marker>
                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" class="canvas-grid"/>
                        </pattern>
                    </defs>
                    
                    <!-- Grid background -->
                    <rect width="100%" height="100%" fill="url(#grid)" />
                    
                    <!-- Main content group for zoom/pan -->
                    <g id="main-group">
                        <!-- Connections will be rendered here -->
                        <g id="connections-group"></g>
                        <!-- Nodes will be rendered here -->
                        <g id="nodes-group"></g>
                    </g>
                </svg>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="switchTab('properties')">Properties</button>
                    <button class="sidebar-tab" onclick="switchTab('questions')">Questions</button>
                    <button class="sidebar-tab" onclick="switchTab('notes')">Notes</button>
                </div>
                
                <div class="sidebar-content">
                    <!-- Properties tab -->
                    <div id="properties-tab" class="tab-content">
                        <div id="no-selection" class="text-center text-muted">
                            <p>Select a node or connection to edit properties</p>
                        </div>
                        
                        <div id="node-properties" style="display: none;">
                            <div class="property-group">
                                <label class="property-label">Node Text</label>
                                <input type="text" class="property-input" id="node-text" placeholder="Enter node text">
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Node Type</label>
                                <select class="property-input" id="node-type">
                                    <option value="start">Start</option>
                                    <option value="process">Process</option>
                                    <option value="decision">Decision</option>
                                    <option value="end">End</option>
                                    <option value="connector">Connector</option>
                                </select>
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Status</label>
                                <div class="status-buttons">
                                    <button class="status-btn" data-status="pending" onclick="setNodeStatus('pending')">Pending</button>
                                    <button class="status-btn" data-status="approved" onclick="setNodeStatus('approved')">Approved</button>
                                    <button class="status-btn" data-status="rejected" onclick="setNodeStatus('rejected')">Rejected</button>
                                </div>
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Implementation Notes</label>
                                <textarea class="property-input" id="node-notes" rows="3" placeholder="Add implementation notes..."></textarea>
                            </div>
                            
                            <div class="property-group">
                                <button class="btn btn-sm btn-danger" onclick="deleteSelectedNode()">üóëÔ∏è Delete Node</button>
                            </div>
                        </div>
                        
                        <div id="connection-properties" style="display: none;">
                            <div class="property-group">
                                <label class="property-label">Connection Label</label>
                                <input type="text" class="property-input" id="connection-label" placeholder="Yes/No/condition">
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Line Style</label>
                                <select class="property-input" id="connection-style">
                                    <option value="solid">Solid</option>
                                    <option value="dashed">Dashed</option>
                                    <option value="dotted">Dotted</option>
                                </select>
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Status</label>
                                <div class="status-buttons">
                                    <button class="status-btn" data-status="pending" onclick="setConnectionStatus('pending')">Pending</button>
                                    <button class="status-btn" data-status="approved" onclick="setConnectionStatus('approved')">Approved</button>
                                    <button class="status-btn" data-status="rejected" onclick="setConnectionStatus('rejected')">Rejected</button>
                                </div>
                            </div>
                            
                            <div class="property-group">
                                <button class="btn btn-sm btn-danger" onclick="deleteSelectedConnection()">üóëÔ∏è Delete Connection</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Questions tab -->
                    <div id="questions-tab" class="tab-content" style="display: none;">
                        <div id="questions-list">
                            <!-- Questions will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Notes tab -->
                    <div id="notes-tab" class="tab-content" style="display: none;">
                        <div class="property-group">
                            <label class="property-label">Flowchart Description</label>
                            <textarea class="property-input" id="flowchart-description" rows="4" placeholder="Describe the purpose and context of this flowchart..."></textarea>
                        </div>
                        
                        <div class="property-group">
                            <label class="property-label">General Notes</label>
                            <textarea class="property-input" id="general-notes" rows="6" placeholder="Add general notes, TODOs, or feedback..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status bar -->
        <div class="status-bar">
            <div class="status-info">
                <span id="node-count">Nodes: 0</span>
                <span id="connection-count">Connections: 0</span>
                <span id="zoom-level">Zoom: 100%</span>
            </div>
            <div class="status-info">
                <span id="last-saved">Not saved</span>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div id="importExportModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Import Flowchart JSON</h2>
            <textarea id="importExportArea" class="import-export-area" placeholder="Paste your flowchart JSON here..."></textarea>
            <div class="modal-actions">
                <button class="btn btn-primary" id="modalActionBtn" onclick="processImport()">üì• Import</button>
                <button class="btn btn-secondary" onclick="copyExportContent()">üìã Copy to Clipboard</button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Include shared utilities -->
    <script src="assets/js/utils.js?v=2"></script>
    <script src="assets/js/ui.js?v=2"></script>
    <script src="assets/js/analytics.js?v=2"></script>
    
    <!-- Flowchart-specific JavaScript -->
    <script src="assets/js/flowchart.js?v=2"></script>
    
    <script>
        // Initialize the application
        let flowchartEditor;
        let selectedNodeType = null;
        let currentMode = 'select';
        let selectedElement = null;

        document.addEventListener('DOMContentLoaded', function() {
            flowchartEditor = new FlowchartEditor('flowchart-canvas');
            
            // Track page view for analytics
            if (typeof window.trackEvent !== 'undefined') {
                window.trackEvent('page_view', { tool: 'flowchart-collaborator' });
            }
            
            // Load any saved data (with slight delay to ensure all modules are loaded)
            setTimeout(loadFromLocalStorage, 100);
            
            // Set up auto-save
            setInterval(saveToLocalStorage, 30000); // Auto-save every 30 seconds
        });

        // Modal functions
        function showImportModal() {
            document.getElementById('modalTitle').textContent = 'Import Flowchart JSON';
            document.getElementById('modalActionBtn').textContent = 'üì• Import';
            document.getElementById('modalActionBtn').onclick = processImport;
            document.getElementById('importExportArea').value = '';
            document.getElementById('importExportArea').placeholder = 'Paste your flowchart JSON here...';
            document.getElementById('importExportModal').classList.add('active');
        }

        function exportToJSON() {
            const exportData = flowchartEditor.exportToJSON();
            document.getElementById('modalTitle').textContent = 'Export Flowchart JSON';
            document.getElementById('modalActionBtn').textContent = 'üì§ Export Setup Instructions';
            document.getElementById('modalActionBtn').onclick = generateSetupInstructions;
            document.getElementById('importExportArea').value = JSON.stringify(exportData, null, 2);
            document.getElementById('importExportArea').placeholder = '';
            document.getElementById('importExportModal').classList.add('active');
        }

        function processImport() {
            const jsonText = document.getElementById('importExportArea').value.trim();
            if (!jsonText) {
                showNotification('Please paste JSON data to import', 'warning');
                return;
            }
            
            try {
                const flowchartData = JSON.parse(jsonText);
                flowchartEditor.loadFromJSON(flowchartData);
                closeModal();
                showNotification('Flowchart imported successfully!', 'success');
                
                if (typeof window.trackEvent !== 'undefined') {
                    window.trackEvent('flowchart_imported');
                }
            } catch (error) {
                showNotification('Invalid JSON format. Please check your data.', 'error');
                console.error('Import error:', error);
            }
        }

        function generateSetupInstructions() {
            const exportData = flowchartEditor.exportToJSON();
            const instructions = `Please review and improve this flowchart design:\n\n${JSON.stringify(exportData, null, 2)}\n\nPlease provide:\n1. Feedback on the flowchart structure and logic\n2. Suggestions for improvements or missing steps\n3. Questions about implementation details\n4. Updated JSON with your recommendations`;
            
            navigator.clipboard.writeText(instructions).then(() => {
                showNotification('Setup instructions copied to clipboard!', 'success');
                closeModal();
            }).catch(() => {
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        function copyExportContent() {
            const textarea = document.getElementById('importExportArea');
            const textToCopy = textarea.value;
            
            copyToClipboard(textToCopy);
        }

        function closeModal() {
            document.getElementById('importExportModal').classList.remove('active');
        }

        // Toolbar functions
        function selectNodeType(type) {
            selectedNodeType = type;
            
            // Update button states
            document.querySelectorAll('.node-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            setMode('add');
        }

        function setMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.querySelectorAll('#selectMode, #connectMode').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'select') {
                document.getElementById('selectMode').classList.add('active');
                selectedNodeType = null;
                document.querySelectorAll('.node-type-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            } else if (mode === 'connect') {
                document.getElementById('connectMode').classList.add('active');
            }
            
            // Update cursor
            const canvas = document.getElementById('flowchart-canvas');
            canvas.style.cursor = mode === 'connect' ? 'crosshair' : 'grab';
        }

        function fitToScreen() {
            flowchartEditor.fitToScreen();
        }

        function resetZoom() {
            flowchartEditor.resetZoom();
        }

        function saveProgress() {
            saveToLocalStorage();
            showNotification('Progress saved!', 'success');
        }

        function clearCanvas() {
            if (confirm('Are you sure you want to clear the entire flowchart? This cannot be undone.')) {
                flowchartEditor.clearAll();
                clearSelection();
                showNotification('Canvas cleared', 'info');
                
                if (typeof window.trackEvent !== 'undefined') {
                    window.trackEvent('flowchart_cleared');
                }
            }
        }

        // Sidebar functions
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${tabName}-tab`).style.display = 'block';
        }

        function clearSelection() {
            selectedElement = null;
            updatePropertiesPanel();
            flowchartEditor.clearSelection();
        }

        function updatePropertiesPanel() {
            const noSelection = document.getElementById('no-selection');
            const nodeProperties = document.getElementById('node-properties');
            const connectionProperties = document.getElementById('connection-properties');
            
            // Hide all panels first
            noSelection.style.display = 'none';
            nodeProperties.style.display = 'none';
            connectionProperties.style.display = 'none';
            
            if (!selectedElement) {
                noSelection.style.display = 'block';
                return;
            }
            
            if (selectedElement.type === 'node') {
                nodeProperties.style.display = 'block';
                populateNodeProperties(selectedElement);
            } else if (selectedElement.type === 'connection') {
                connectionProperties.style.display = 'block';
                populateConnectionProperties(selectedElement);
            }
        }

        function populateNodeProperties(node) {
            document.getElementById('node-text').value = node.text || '';
            document.getElementById('node-type').value = node.nodeType || 'process';
            document.getElementById('node-notes').value = node.metadata?.note || '';
            
            // Update status buttons
            const status = node.metadata?.status || 'pending';
            document.querySelectorAll('#node-properties .status-btn').forEach(btn => {
                btn.classList.remove('approved', 'pending', 'rejected');
                if (btn.dataset.status === status) {
                    btn.classList.add(status);
                }
            });
        }

        function populateConnectionProperties(connection) {
            document.getElementById('connection-label').value = connection.label || '';
            document.getElementById('connection-style').value = connection.style || 'solid';
            
            // Update status buttons
            const status = connection.metadata?.status || 'pending';
            document.querySelectorAll('#connection-properties .status-btn').forEach(btn => {
                btn.classList.remove('approved', 'pending', 'rejected');
                if (btn.dataset.status === status) {
                    btn.classList.add(status);
                }
            });
        }

        // Property update functions
        function setNodeStatus(status) {
            if (selectedElement && selectedElement.type === 'node') {
                flowchartEditor.updateNodeStatus(selectedElement.id, status);
                populateNodeProperties(selectedElement);
                saveToLocalStorage();
            }
        }

        function setConnectionStatus(status) {
            if (selectedElement && selectedElement.type === 'connection') {
                flowchartEditor.updateConnectionStatus(selectedElement.id, status);
                populateConnectionProperties(selectedElement);
                saveToLocalStorage();
            }
        }

        function deleteSelectedNode() {
            if (selectedElement && selectedElement.type === 'node') {
                if (confirm('Are you sure you want to delete this node and all its connections?')) {
                    flowchartEditor.deleteNode(selectedElement.id);
                    clearSelection();
                    saveToLocalStorage();
                }
            }
        }

        function deleteSelectedConnection() {
            if (selectedElement && selectedElement.type === 'connection') {
                if (confirm('Are you sure you want to delete this connection?')) {
                    flowchartEditor.deleteConnection(selectedElement.id);
                    clearSelection();
                    saveToLocalStorage();
                }
            }
        }

        // Storage functions
        function saveToLocalStorage() {
            if (typeof window.ToolBeltStorage !== 'undefined' && window.ToolBeltStorage.save) {
                const data = flowchartEditor.exportToJSON();
                window.ToolBeltStorage.save('flowchart-collaborator', data);
                document.getElementById('last-saved').textContent = `Saved: ${new Date().toLocaleTimeString()}`;
            }
        }

        function loadFromLocalStorage() {
            if (typeof window.ToolBeltStorage !== 'undefined' && window.ToolBeltStorage.load) {
                const data = window.ToolBeltStorage.load('flowchart-collaborator');
                if (data) {
                    flowchartEditor.loadFromJSON(data);
                    document.getElementById('last-saved').textContent = 'Loaded from storage';
                }
            }
        }

        // Event listeners for property changes
        document.addEventListener('DOMContentLoaded', function() {
            // Node property listeners
            document.getElementById('node-text').addEventListener('input', function() {
                if (selectedElement && selectedElement.type === 'node') {
                    flowchartEditor.updateNodeText(selectedElement.id, this.value);
                    saveToLocalStorage();
                }
            });
            
            document.getElementById('node-type').addEventListener('change', function() {
                if (selectedElement && selectedElement.type === 'node') {
                    flowchartEditor.updateNodeType(selectedElement.id, this.value);
                    saveToLocalStorage();
                }
            });
            
            document.getElementById('node-notes').addEventListener('input', function() {
                if (selectedElement && selectedElement.type === 'node') {
                    flowchartEditor.updateNodeNotes(selectedElement.id, this.value);
                    saveToLocalStorage();
                }
            });
            
            // Connection property listeners
            document.getElementById('connection-label').addEventListener('input', function() {
                if (selectedElement && selectedElement.type === 'connection') {
                    flowchartEditor.updateConnectionLabel(selectedElement.id, this.value);
                    saveToLocalStorage();
                }
            });
            
            document.getElementById('connection-style').addEventListener('change', function() {
                if (selectedElement && selectedElement.type === 'connection') {
                    flowchartEditor.updateConnectionStyle(selectedElement.id, this.value);
                    saveToLocalStorage();
                }
            });
            
            // General notes listeners
            document.getElementById('flowchart-description').addEventListener('input', function() {
                flowchartEditor.updateDescription(this.value);
                saveToLocalStorage();
            });
            
            document.getElementById('general-notes').addEventListener('input', function() {
                flowchartEditor.updateGeneralNotes(this.value);
                saveToLocalStorage();
            });
        });
    </script>
</body>
</html>